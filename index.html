<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lista de Compras</title>
    <!-- Fontes Google -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Pacifico&family=Roboto:wght@400;700&family=Roboto+Condensed:wght@400;700&display=swap" rel="stylesheet">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .font-handwritten { font-family: 'Pacifico', cursive; }
        .font-roboto { font-family: 'Roboto', sans-serif; }
        .font-roboto-condensed { font-family: 'Roboto Condensed', sans-serif; }
        
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }

        .modal-enter { animation: zoomIn 0.2s ease-out; }
        @keyframes zoomIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        .menu-slide-up { animation: slideUp 0.3s ease-out; }
        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }

        /* Feedback visual para bot√µes ativos */
        button:active { transform: scale(0.95); transition: transform 0.1s; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 font-roboto-condensed pb-40 select-none">

    <!-- Notifica√ß√µes -->
    <div id="toast" class="fixed top-4 left-1/2 -translate-x-1/2 z-[100] px-6 py-3 rounded-full shadow-lg flex items-center gap-2 hidden transition-all duration-300 bg-black text-white">
        <span id="toast-text" class="text-sm font-bold"></span>
    </div>

    <!-- Header -->
    <header onclick="openMenu()" class="p-6 bg-white shadow-sm sticky top-0 z-10 cursor-pointer hover:bg-gray-50 transition-colors">
        <h1 class="text-3xl text-center text-black font-handwritten">
            Lista de Compras
        </h1>
    </header>

    <!-- Main List Content -->
    <main id="list-container" class="max-w-md mx-auto p-4 space-y-2">
        <div class="text-center py-20 text-gray-400 italic">
            Nenhum item na lista.
        </div>
    </main>

    <!-- Floating Controls -->
    <div class="fixed bottom-6 left-0 right-0 px-6 flex items-end justify-between max-w-md mx-auto z-20 pointer-events-none">
        <!-- Total/Budget Box -->
        <div id="total-box" onclick="openBudgetModal()" class="bg-emerald-500 text-white p-4 rounded-3xl shadow-xl flex flex-col min-w-[140px] cursor-pointer pointer-events-auto transition-colors duration-300">
            <div id="total-display" class="font-roboto font-bold text-xl">R$ 0,00</div>
            <div id="budget-info" class="hidden mt-1 pt-1 border-t border-white/20 text-[10px] font-roboto space-y-0.5">
                <div class="flex justify-between opacity-80">
                    <span id="budget-value">R$ 0,00</span>
                </div>
                <div class="flex justify-between font-bold">
                    <span id="balance-label">Troco: </span>
                    <span id="balance-value">R$ 0,00</span>
                </div>
            </div>
        </div>

        <!-- Add Button -->
        <button onclick="openProductModal('add')" class="bg-blue-500 text-white w-14 h-14 rounded-full shadow-xl flex items-center justify-center pointer-events-auto active:scale-90 transition-transform">
            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
        </button>
    </div>

    <!-- Modal: Produto -->
    <div id="product-modal" class="fixed inset-0 bg-black/70 backdrop-blur-sm z-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white w-full max-w-sm rounded-[2rem] p-6 shadow-2xl modal-enter">
            <form id="product-form" class="space-y-6">
                <div id="error-msg" class="text-red-500 text-xs font-bold flex items-center gap-1 hidden">
                    ‚ö†Ô∏è preencha o nome e o pre√ßo.
                </div>
                
                <input id="p-name" type="text" placeholder="escreva aqui o nome e marca do produto" class="w-full bg-gray-50 border-b-2 border-gray-100 p-3 outline-none focus:border-blue-500 text-lg">
                
                <div class="flex items-center gap-2">
                    <span class="font-bold text-gray-300 font-roboto">R$</span>
                    <input id="p-price" type="number" step="0.01" placeholder="pre√ßo unit√°rio" class="w-full bg-gray-50 border-b-2 border-gray-100 p-3 outline-none focus:border-blue-500 font-roboto font-bold text-xl">
                </div>

                <div class="flex items-center justify-between bg-gray-50 p-2 rounded-2xl">
                    <div class="flex gap-1">
                        <button type="button" onclick="adjustQty(-10)" class="w-8 h-8 bg-white shadow-sm rounded-lg text-[10px] font-bold text-red-500">-10</button>
                        <button type="button" onclick="adjustQty(-5)" class="w-8 h-8 bg-white shadow-sm rounded-lg text-[10px] font-bold text-red-500">-5</button>
                        <button type="button" onclick="adjustQty(-1)" class="w-8 h-8 bg-white shadow-sm rounded-lg text-xs font-bold text-red-500">-1</button>
                    </div>
                    <input id="p-qty" type="number" step="any" class="w-14 bg-transparent text-center font-bold text-xl outline-none" value="1">
                    <div class="flex gap-1">
                        <button type="button" onclick="adjustQty(1)" class="w-8 h-8 bg-white shadow-sm rounded-lg text-xs font-bold text-blue-500">+1</button>
                        <button type="button" onclick="adjustQty(5)" class="w-8 h-8 bg-white shadow-sm rounded-lg text-[10px] font-bold text-blue-500">+5</button>
                        <button type="button" onclick="adjustQty(10)" class="w-8 h-8 bg-white shadow-sm rounded-lg text-[10px] font-bold text-blue-500">+10</button>
                    </div>
                </div>

                <div class="flex gap-3 pt-2">
                    <button type="button" onclick="closeModal('product-modal')" class="flex-1 py-3 font-bold text-gray-400">cancelar</button>
                    <button type="submit" class="flex-1 bg-blue-500 text-white py-3 rounded-2xl font-bold shadow-lg">confirmar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Menu -->
    <div id="menu-modal" class="fixed inset-0 bg-black/70 backdrop-blur-md z-50 flex items-end justify-center hidden">
        <div class="bg-white w-full max-w-md rounded-t-[2.5rem] p-8 shadow-2xl menu-slide-up">
            <div class="w-12 h-1.5 bg-gray-200 rounded-full mx-auto mb-8" onclick="closeModal('menu-modal')"></div>
            <div class="space-y-4">
                <button onclick="copyAsText()" class="w-full flex items-center gap-4 p-4 bg-gray-50 rounded-2xl">
                    <div class="bg-blue-100 text-blue-600 p-3 rounded-xl">üìã</div>
                    <div class="text-left">
                        <div class="font-bold text-gray-800">Copiar Texto</div>
                        <div class="text-xs text-gray-400">Formatado para WhatsApp</div>
                    </div>
                </button>

                <button onclick="exportToFile()" class="w-full flex items-center gap-4 p-4 bg-gray-50 rounded-2xl">
                    <div class="bg-emerald-100 text-emerald-600 p-3 rounded-xl">üíæ</div>
                    <div class="text-left">
                        <div class="font-bold text-gray-800">Baixar Arquivo (.txt)</div>
                        <div class="text-xs text-gray-400">Salvar lista no dispositivo</div>
                    </div>
                </button>

                <label class="w-full flex items-center gap-4 p-4 bg-gray-50 rounded-2xl cursor-pointer">
                    <div class="bg-purple-100 text-purple-600 p-3 rounded-xl">üìÇ</div>
                    <div class="text-left">
                        <div class="font-bold text-gray-800">Abrir Arquivo (.txt)</div>
                        <div class="text-xs text-gray-400">Carregar uma lista salva</div>
                    </div>
                    <input type="file" accept=".txt" class="hidden" onchange="importFromFile(event)">
                </label>

                <button onclick="closeModal('menu-modal')" class="w-full py-4 text-gray-400 font-bold uppercase tracking-widest text-xs mt-4">Fechar Menu</button>
            </div>
        </div>
    </div>

    <!-- Modal: Saldo -->
    <div id="budget-modal" class="fixed inset-0 bg-black/70 backdrop-blur-sm z-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white w-full max-w-sm rounded-[2rem] p-6 shadow-2xl modal-enter">
            <input id="budget-input" type="number" step="0.01" placeholder="informe seu saldo" class="w-full bg-gray-50 rounded-2xl p-5 outline-none focus:ring-4 focus:ring-emerald-100 font-roboto font-bold text-2xl text-center">
            <div class="flex flex-col gap-2 mt-6">
                <button onclick="setBudget()" class="w-full bg-emerald-500 text-white py-4 rounded-xl font-bold">definir saldo</button>
                <button onclick="clearBudget()" class="w-full py-2 text-red-400 text-xs font-bold">limpar saldo</button>
                <button onclick="closeModal('budget-modal')" class="w-full py-2 text-gray-400 text-xs">fechar</button>
            </div>
        </div>
    </div>

    <script>
        // Estado da aplica√ß√£o (Totalmente Local)
        let state = {
            items: [],
            budget: null,
            editingId: null
        };

        const fmt = (v) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(v || 0);

        function showToast(text) {
            const el = document.getElementById('toast');
            document.getElementById('toast-text').innerText = text;
            el.classList.remove('hidden');
            setTimeout(() => el.classList.add('hidden'), 3000);
        }

        function render() {
            const container = document.getElementById('list-container');
            const totalDisplay = document.getElementById('total-display');
            const totalBox = document.getElementById('total-box');
            const budgetInfo = document.getElementById('budget-info');

            if (state.items.length === 0) {
                container.innerHTML = `<div class="text-center py-20 text-gray-400 italic">Nenhum item na lista.</div>`;
            } else {
                container.innerHTML = state.items.map(item => `
                    <div onclick="openProductModal('edit', '${item.id}')" class="bg-white p-3 rounded-xl shadow-sm border border-gray-100 flex items-center gap-3 active:bg-gray-50 transition-colors">
                        <button onclick="removeItem(event, '${item.id}')" class="bg-red-50 text-red-400 p-2 rounded-lg">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                        </button>
                        <div class="bg-blue-50 px-2 py-1 rounded-lg min-w-[40px] text-center font-bold text-blue-600">${item.quantity}</div>
                        <div class="flex-1 truncate font-bold text-gray-700 text-base">${item.name}</div>
                        <div class="text-right flex flex-col items-end min-w-[80px]">
                            <span class="text-[10px] text-gray-400 leading-none">${fmt(item.price)}</span>
                            <span class="font-roboto font-bold text-emerald-600 text-sm">${fmt(item.price * item.quantity)}</span>
                        </div>
                    </div>
                `).join('');
            }

            const total = state.items.reduce((acc, i) => acc + (i.price * i.quantity), 0);
            totalDisplay.innerText = fmt(total);

            if (state.budget !== null) {
                const balance = state.budget - total;
                const isOver = balance < 0;
                totalBox.className = `${isOver ? 'bg-red-500' : 'bg-emerald-500'} text-white p-4 rounded-3xl shadow-xl flex flex-col min-w-[140px] cursor-pointer pointer-events-auto transition-colors duration-300`;
                budgetInfo.classList.remove('hidden');
                document.getElementById('budget-value').innerText = fmt(state.budget);
                document.getElementById('balance-label').innerText = isOver ? 'Falta: ' : 'Troco: ';
                document.getElementById('balance-value').innerText = fmt(Math.abs(balance));
            } else {
                totalBox.className = 'bg-emerald-500 text-white p-4 rounded-3xl shadow-xl flex flex-col min-w-[140px] cursor-pointer pointer-events-auto transition-colors duration-300';
                budgetInfo.classList.add('hidden');
            }
        }

        window.openProductModal = (mode, itemId = null) => {
            let item = null;
            if (itemId) {
                item = state.items.find(i => i.id === itemId);
            }
            state.editingId = item ? item.id : null;
            document.getElementById('p-name').value = item ? item.name : '';
            document.getElementById('p-price').value = item ? item.price : '';
            document.getElementById('p-qty').value = item ? item.quantity : 1;
            document.getElementById('error-msg').classList.add('hidden');
            document.getElementById('product-modal').classList.remove('hidden');
        };

        window.closeModal = (id) => document.getElementById(id).classList.add('hidden');
        window.openMenu = () => document.getElementById('menu-modal').classList.remove('hidden');
        window.openBudgetModal = () => document.getElementById('budget-modal').classList.remove('hidden');
        window.adjustQty = (amt) => {
            const input = document.getElementById('p-qty');
            input.value = Math.max(0, (parseFloat(input.value) || 0) + amt);
        };

        window.setBudget = () => {
            const val = parseFloat(document.getElementById('budget-input').value);
            state.budget = isNaN(val) ? null : val;
            closeModal('budget-modal');
            render();
        };

        window.clearBudget = () => {
            state.budget = null;
            document.getElementById('budget-input').value = '';
            closeModal('budget-modal');
            render();
        };

        window.removeItem = (e, id) => {
            e.stopPropagation();
            state.items = state.items.filter(i => i.id !== id);
            render();
        };

        document.getElementById('product-form').onsubmit = (e) => {
            e.preventDefault();
            const name = document.getElementById('p-name').value;
            const price = parseFloat(document.getElementById('p-price').value);
            const qty = parseFloat(document.getElementById('p-qty').value);

            if (!name.trim() || isNaN(price) || price <= 0) {
                document.getElementById('error-msg').classList.remove('hidden');
                return;
            }

            const product = { id: state.editingId || Date.now().toString(), name, price, quantity: qty || 1 };

            if (state.editingId) {
                state.items = state.items.map(i => i.id === state.editingId ? product : i);
            } else {
                state.items.push(product);
            }

            closeModal('product-modal');
            render();
        };

        // EXPORTAR TXT (Para download)
        window.exportToFile = () => {
            if (state.items.length === 0) {
                showToast("Sua lista est√° vazia!");
                return;
            }
            const data = JSON.stringify({ items: state.items, budget: state.budget });
            const blob = new Blob([data], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `lista_compras_${new Date().toLocaleDateString().replace(/\//g, '-')}.txt`;
            a.click();
            URL.revokeObjectURL(url);
            closeModal('menu-modal');
            showToast("Arquivo baixado!");
        };

        // IMPORTAR TXT
        window.importFromFile = (event) => {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.items && Array.isArray(data.items)) {
                        state.items = data.items;
                        state.budget = data.budget || null;
                        render();
                        showToast("Lista carregada!");
                    } else {
                        throw new Error();
                    }
                } catch (err) {
                    showToast("Erro ao ler o arquivo!");
                }
                closeModal('menu-modal');
                event.target.value = ''; // Limpa o input
            };
            reader.readAsText(file);
        };

        window.copyAsText = () => {
            if (state.items.length === 0) return;
            const listText = state.items.map(i => `${i.quantity}x ${i.name} - ${fmt(i.price * i.quantity)}`).join('\n');
            const total = state.items.reduce((acc, i) => acc + (i.price * i.quantity), 0);
            const fullText = `üõí *LISTA DE COMPRAS*\n\n${listText}\n\n*TOTAL:* ${fmt(total)}`;
            
            const el = document.createElement('textarea');
            el.value = fullText;
            document.body.appendChild(el);
            el.select();
            document.execCommand('copy');
            document.body.removeChild(el);
            
            showToast('Texto copiado!');
            closeModal('menu-modal');
        };

        // Inicializa√ß√£o
        render();
    </script>
</body>
</html>
